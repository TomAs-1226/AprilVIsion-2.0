<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC Vision Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>AprilVision 2.1 Dashboard</h1>
        <div class="status-bar">
            <span id="status-uptime">Uptime: --</span>
            <span id="status-temp">CPU: --¬∞C</span>
            <span id="status-nt" class="status-indicator disconnected" title="NetworkTables connection to roboRIO">
                NT: <span id="nt-status-text">Disconnected</span>
                <span id="nt-server-ip" style="font-size: 0.9em;"></span>
            </span>
            <span id="status-clients">Clients: 0</span>
        </div>
    </header>

    <main>
        <!-- Camera Grid -->
        <section class="camera-grid">
            <div class="camera-panel" data-cam="0">
                <div class="camera-header">
                    <h3>Camera 0</h3>
                    <span class="cam-stats">
                        <span class="fps" data-cam="0">-- fps</span>
                        <span class="latency" data-cam="0">-- ms</span>
                        <span class="tags" data-cam="0">0 tags</span>
                    </span>
                </div>
                <div class="camera-container">
                    <img id="cam0-img" alt="Camera 0">
                    <canvas id="cam0-overlay"></canvas>
                </div>
            </div>

            <div class="camera-panel" data-cam="1">
                <div class="camera-header">
                    <h3>Camera 1</h3>
                    <span class="cam-stats">
                        <span class="fps" data-cam="1">-- fps</span>
                        <span class="latency" data-cam="1">-- ms</span>
                        <span class="tags" data-cam="1">0 tags</span>
                    </span>
                </div>
                <div class="camera-container">
                    <img id="cam1-img" alt="Camera 1">
                    <canvas id="cam1-overlay"></canvas>
                </div>
            </div>

            <div class="camera-panel" data-cam="2">
                <div class="camera-header">
                    <h3>Camera 2</h3>
                    <span class="cam-stats">
                        <span class="fps" data-cam="2">-- fps</span>
                        <span class="latency" data-cam="2">-- ms</span>
                        <span class="tags" data-cam="2">0 tags</span>
                    </span>
                </div>
                <div class="camera-container">
                    <img id="cam2-img" alt="Camera 2">
                    <canvas id="cam2-overlay"></canvas>
                </div>
            </div>
        </section>

        <!-- Data Panels -->
        <section class="data-panels">
            <!-- Fused Pose Panel -->
            <div class="panel fused-pose-panel">
                <h3>Robot Pose (Fused)</h3>
                <div class="pose-display">
                    <div class="pose-field">
                        <canvas id="field-canvas" width="400" height="200"></canvas>
                    </div>
                    <div class="pose-values">
                        <div class="pose-row">
                            <label>X:</label>
                            <span id="pose-x">--.--</span>
                            <span class="unit">m</span>
                        </div>
                        <div class="pose-row">
                            <label>Y:</label>
                            <span id="pose-y">--.--</span>
                            <span class="unit">m</span>
                        </div>
                        <div class="pose-row">
                            <label>Œ∏:</label>
                            <span id="pose-theta">--.--</span>
                            <span class="unit">¬∞</span>
                        </div>
                        <div class="pose-row quality">
                            <label>Confidence:</label>
                            <div class="confidence-bar">
                                <div id="confidence-fill"></div>
                            </div>
                            <span id="confidence-value">--%</span>
                        </div>
                        <div class="pose-row">
                            <label>Tags:</label>
                            <span id="total-tags">0</span>
                            <span class="small">from</span>
                            <span id="cameras-count">0</span>
                            <span class="small">cameras</span>
                        </div>
                        <div class="pose-row std-dev">
                            <label>œÉ:</label>
                            <span id="std-x">--.--</span>,
                            <span id="std-y">--.--</span>,
                            <span id="std-theta">--.--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug & Accuracy Panel -->
            <div class="panel debug-panel">
                <h3>Debug & Accuracy</h3>
                <div class="debug-section">
                    <h4>Per-Tag Data</h4>
                    <div id="debug-tags" class="debug-tags-list">
                        <span class="muted">Waiting for detections...</span>
                    </div>
                </div>
                <div class="debug-section">
                    <h4>Per-Camera Latency</h4>
                    <div id="debug-latency" class="debug-latency-list">
                        <span class="muted">--</span>
                    </div>
                </div>
                <div class="debug-section">
                    <h4>Accuracy Test</h4>
                    <p class="muted small-text">Place robot at known position, enter coordinates, click Set.</p>
                    <div class="accuracy-inputs">
                        <div class="config-row">
                            <label for="ref-x">X (m):</label>
                            <input type="number" id="ref-x" step="0.01" value="0" style="width:70px">
                        </div>
                        <div class="config-row">
                            <label for="ref-y">Y (m):</label>
                            <input type="number" id="ref-y" step="0.01" value="0" style="width:70px">
                        </div>
                        <div class="config-row">
                            <label for="ref-theta">Œ∏ (¬∞):</label>
                            <input type="number" id="ref-theta" step="1" value="0" style="width:70px">
                        </div>
                        <div class="config-buttons">
                            <button id="set-reference">Set Reference</button>
                            <button id="clear-reference">Clear</button>
                        </div>
                    </div>
                    <div id="accuracy-result" class="accuracy-result" style="display:none;">
                        <div class="pose-row"><label>Error X:</label><span id="err-x">--</span><span class="unit">m</span></div>
                        <div class="pose-row"><label>Error Y:</label><span id="err-y">--</span><span class="unit">m</span></div>
                        <div class="pose-row"><label>Error Œ∏:</label><span id="err-theta">--</span><span class="unit">¬∞</span></div>
                        <div class="pose-row"><label>Error Dist:</label><span id="err-dist">--</span><span class="unit">m</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="data-panels" style="margin-top: 0;">
            <!-- Configuration Panel -->
            <div class="panel config-panel">
                <h3>Configuration</h3>
                <div class="config-section">
                    <h4>Detector</h4>
                    <div class="config-row">
                        <label for="decimation">Decimation:</label>
                        <input type="range" id="decimation" min="1" max="4" value="2">
                        <span id="decimation-value">2</span>
                    </div>
                    <div class="config-row">
                        <label for="min-margin">Min Margin:</label>
                        <input type="range" id="min-margin" min="5" max="50" value="20">
                        <span id="min-margin-value">20</span>
                    </div>
                    <div class="config-row">
                        <label for="max-tags">Max Tags:</label>
                        <input type="range" id="max-tags" min="4" max="32" value="16">
                        <span id="max-tags-value">16</span>
                    </div>
                </div>
                <div class="config-section">
                    <h4>Tracking</h4>
                    <div class="config-row">
                        <label for="tracking-enabled">Enabled:</label>
                        <input type="checkbox" id="tracking-enabled" checked>
                    </div>
                    <div class="config-row">
                        <label for="filter-alpha">Smoothing:</label>
                        <input type="range" id="filter-alpha" min="0.1" max="1.0" step="0.1" value="0.3">
                        <span id="filter-alpha-value">0.3</span>
                    </div>
                </div>
                <div class="config-section">
                    <h4>Display</h4>
                    <div class="config-row">
                        <label for="show-overlay">Show Overlay:</label>
                        <input type="checkbox" id="show-overlay" checked>
                    </div>
                    <div class="config-row">
                        <label for="jpeg-quality">JPEG Quality:</label>
                        <input type="range" id="jpeg-quality" min="30" max="100" value="70">
                        <span id="jpeg-quality-value">70</span>
                    </div>
                </div>
                <div class="config-buttons">
                    <button id="apply-config">Apply</button>
                    <button id="reload-config">Reload from File</button>
                </div>
            </div>

            <!-- NEW: Phase 3 Auto-Align & Testing Panel -->
            <div class="panel autoalign-panel">
                <h3>üéØ Phase 3: Auto-Align & Testing</h3>

                <!-- Testing Modes -->
                <div class="config-section">
                    <h4>Testing Modes</h4>
                    <div class="testing-controls">
                        <button id="start-calibration-mode" class="test-button">
                            üì∑ Start Calibration Mode
                        </button>
                        <button id="start-validation-mode" class="test-button">
                            ‚úÖ Start Validation Test (1.5m)
                        </button>
                        <button id="start-diagnostics" class="test-button">
                            üîß Run Diagnostics
                        </button>
                        <button id="stop-test-mode" class="test-button danger" style="display:none;">
                            ‚èπ Stop Test Mode
                        </button>
                    </div>
                    <div id="test-mode-status" class="test-status" style="display:none;">
                        <strong>Test Mode Active:</strong> <span id="current-test-mode">--</span><br>
                        <span id="test-instructions">--</span>
                    </div>
                </div>

                <!-- Auto-Align Control -->
                <div class="config-section">
                    <h4>Auto-Align (Phase 3)</h4>
                    <div class="config-row">
                        <label for="target-tag-id">Target Tag ID:</label>
                        <input type="number" id="target-tag-id" min="1" max="16" value="7" style="width:60px">
                        <button id="set-align-target">Set Target</button>
                    </div>
                    <div class="config-row">
                        <label for="shooting-distance">Shooting Distance:</label>
                        <input type="number" id="shooting-distance" min="1.0" max="5.0" step="0.5" value="2.5" style="width:60px">
                        <span class="unit">m</span>
                    </div>
                    <div class="config-row">
                        <label>Alliance:</label>
                        <label style="margin-left: 10px;">
                            <input type="radio" name="alliance" value="blue" checked> Blue
                        </label>
                        <label style="margin-left: 10px;">
                            <input type="radio" name="alliance" value="red"> Red
                        </label>
                    </div>
                    <button id="calculate-positions" class="test-button">
                        üéØ Calculate Shooting Positions
                    </button>
                </div>

                <!-- Auto-Align Status -->
                <div id="autoalign-status" class="autoalign-status" style="display:none;">
                    <div class="status-row">
                        <label>Target Visible:</label>
                        <span id="target-visible" class="status-indicator">--</span>
                    </div>
                    <div class="status-row">
                        <label>Distance to Target:</label>
                        <span id="align-distance">--</span> m
                    </div>
                    <div class="status-row">
                        <label>Heading Error:</label>
                        <span id="heading-error">--</span>¬∞
                    </div>
                    <div class="status-row">
                        <label>Status:</label>
                        <span id="align-stage" class="badge">--</span>
                    </div>
                    <div class="status-row">
                        <label>Ready to Shoot:</label>
                        <span id="ready-to-shoot" class="status-indicator">--</span>
                    </div>
                </div>

                <!-- Shooting Positions List -->
                <div id="shooting-positions" class="shooting-positions" style="display:none;">
                    <h4>Recommended Shooting Positions</h4>
                    <div id="positions-list"></div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>AprilVision 2.1 | Phase 1 + 2 + 3 Complete | FRC 2026 Season</p>
    </footer>

    <script src="app.js"></script>
</body>
</html>
